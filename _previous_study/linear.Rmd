---
title: "seminar"
output: html_document
date: "2025-11-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ellipse)
library(leaps)
library(MASS)
library(glmnet)
library(plotly)
library(broom)
library(GGally)
library(gridExtra)
library(ggfortify)
library(ggcorrplot)
library(tidyverse)
library(dplyr)
library(rstatix)
library(reshape2)
library(psych)
library(plotly)

library(dbscan)
library(depmixS4)
library(mhsmm)
library(kernlab)

library(corrplot)
library(BioStatR)
library(ggplot2)
library(FactoMineR)
library(rsvd)
library(stats)
library(factoextra)
library(rpca)
library(forecast)
library(TSstudio)
library(tseries)
library(FinTS)
library(trend)
library(urca)
library(tvReg)
library(rugarch)
library(prophet)
library(fpp3)
library(changepoint)
library(splines)
library(splines2)
library(fBasics)
library(readxl)
```


```{r}
data = read.csv("D:\\GMM 4\\Reading seminar\\T24S12-04_E-AL2889.csv")
```

```{r}
head(data)
```

```{r}
summary(data)
```

```{r}
datetime = data$datetime
data = data[,-1]
head(data)
```


```{r}
corrplot(cor(data))
```

#PCA

```{r}
data.scale = scale(data, center = T, scale = T)
res.pca = PCA(data.scale, scale.unit = T, graph = F)
fviz_eig(res.pca, addlabels = T)

```

```{r}
fviz_pca_ind(res.pca, axes = c(1,2), geom = "point")
fviz_pca_ind(res.pca, axes = c(2,3), geom = "point")
fviz_pca_var(res.pca)
fviz_pca_var(res.pca, axes = c(1,3))
fviz_pca_var(res.pca, axes = c(1,4))
```

```{r}

df = res.pca$ind$coord[,1:3]
colnames(df) = c("C1", "C2", "C3")
df = as.data.frame(df)
df$t = 1:nrow(df)
fig <- plot_ly(df, x = ~C1, y = ~C2, z = ~C3, color = ~t, alpha = 0.7)
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'C1'),
                     yaxis = list(title = 'C2'),
                     zaxis = list(title = 'C3')))

fig
```


##DBSCAN

On utilise le clustering pour déterminer les outliers dans l'espace latent.

```{r}
data.clust = res.pca$ind$coord[,c(1,2,3,4)]
res.dbscan = dbscan(data.clust[,1:2], eps = 0.2)
res.dbscan
```

```{r}
fviz_pca_ind(res.pca, axes = c(1,2), geom = "point", col.ind = as.factor(res.dbscan$cluster))

```

```{r}
outlier_ind = res.dbscan$cluster == 0
sensor <- "g2"                          # or numeric column index
i <- if (is.character(sensor)) which(colnames(data.scale)==sensor) else sensor

ind = 1:nrow(data)
ind = ind[outlier_ind]
plot(data[,i], type = 'l')
points(ind, data[outlier_ind,i], col = 'red', pch=19, cex=.6)
```

##reconstruction

```{r}
mu <- attr(data.scale, "scaled:center")
sigma <- attr(data.scale, "scaled:scale")

r = 4
eigval <- res.pca$eig[1:r, 1]
data.re = as.matrix(res.pca$svd$U[,1:r])%*% diag(res.pca$svd$vs[1:r]) %*% as.matrix(t(res.pca$svd$V[,1:r]))
plot(data.scale[,7], type = 'l', ylim = c(-5, 5))
lines(data.re[,7], col = 'red')

Error = data.scale - data.re # Q statistique
boxplot(Error)
```

```{r}
score_PCA <- rowSums(abs(Error))              # L1 per time
thr   <- quantile(score_PCA, 0.99)      # 1% tail (adjust)

plot(score_PCA, type="l", main="RPCA anomaly score over time",
     xlab="time index", ylab="sum |S|")
abline(h=thr, col="red", lty=2)
```

```{r}
Error_long <- melt(abs(Error))
colnames(Error_long) <- c("time","sensor","amp")

ggplot(Error_long, aes(sensor, time, fill=amp)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title="PCA anomaly heatmap (|Error|)", x="", y="time") +
  theme_minimal()
```


##HMM

Le hidden markov model est pour déterminer la transition entre les états, et on peut l'utiliser pour détecter les transitions "anormales".

```{r}
set.seed(1234)
Z <- data.frame(Dim1 = res.pca$ind$coord[,1],
                Dim2 = res.pca$ind$coord[,2],
                Dim3 = res.pca$ind$coord[,3],
                Dim4 = res.pca$ind$coord[,4])
mod <- depmix(list(Dim1 ~ 1, Dim2 ~ 1, Dim3 ~ 1, Dim4 ~ 1), data = Z,
              nstates = 3, family = list(gaussian(), gaussian(), gaussian(), gaussian()))
fit <- fit(mod)
regime <- posterior(fit, type = c("viterbi"))$state
```

```{r}
Z$Regime <- factor(regime)

ggplot(Z, aes(x = Dim1, y = Dim2, color = Regime)) +
  geom_point(size = 0.6, alpha = 0.6) +
  theme_minimal() +
  labs(title = "Hidden Markov Model Regimes in PCA space")
```

```{r}
plot(regime, type = "l", col = "darkgreen",
     main = "Regime sequence over time",
     ylab = "Regime", xlab = "Time index")

op <- par(mfrow = c(4,1), mar = c(3,4,2,1))
plot(data$fprd1, col = regime)
plot(data$fprd2, col = regime)
plot(data$pstr1, col = regime)
plot(data$pstr3, col = regime)
par(op)

op <- par(mfrow = c(3,1), mar = c(3,4,2,1))
plot(data$astrw, col = regime)
plot(data$ny, col = regime)
plot(data$g2, col = regime)
par(op)
```

```{r}

plot(data$vcrf, col = regime)
plot(data$v2, col = regime)

```


```{r}
t(aggregate(data,
          by = list(Regime = regime), mean))
```


#RPCA

```{r}

rpca.fit = rpca::rpca(data.scale)
summary(rpca.fit)
```

```{r}
L = rpca.fit$L
S = rpca.fit$S

svd_L <- rpca.fit$L.svd
U <- svd_L$u
Sigma <- svd_L$d
V <- svd_L$vt
Sigma
```


What is the meaning of the new dimensions ?
```{r}
colnames(V) <- colnames(data)
t(V)
```


```{r}
r <- 7
scores <- U[, 1:r] %*% diag(Sigma[1:r])
loadings <- V[1:r,]

# Plot in low-dim space
plot(scores[,1], scores[,2],
     col = ifelse(rowSums(abs(S)) > quantile(rowSums(abs(S)), 0.99), "red", "grey"),
     pch=19, xlab="Latent 1", ylab="Latent 2",
     main="Low-rank latent space (RPCA)")
legend("topright", c("Normal","Anomaly"), col=c("grey","red"), pch=19)
```

```{r}
df = scores[,1:3]
colnames(df) = c("V1", "V2", "V3")
df = as.data.frame(df)
df$t = 1:nrow(df)
fig <- plot_ly(df, x = ~V1, y = ~V2, z = ~V3, color = ~t, alpha = 0.8)
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'V1'),
                     yaxis = list(title = 'V2'),
                     zaxis = list(title = 'V3')))

fig
```


Global anomaly score over time
```{r}
score_t <- rowSums(abs(S))              # L1 per time
thr_t   <- quantile(score_t, 0.99)      # 1% tail (adjust)
flag_t  <- score_t > thr_t

plot(score_t, type="l", main="RPCA anomaly score over time",
     xlab="time index", ylab="sum |S|")
abline(h=thr_t, col="red", lty=2)
```

```{r}
score_i <- colSums(abs(S))              # L1 per sensor

plot(score_i, type="p", main="RPCA anomaly score of each sensor",
     xlab="sensor", ylab="sum |S|")
```


Mark outlier points on a specific sensor
```{r}
sensor <- "v2"                          # or numeric column index
i <- if (is.character(sensor)) which(colnames(data.scale)==sensor) else sensor
thr <- quantile(S[,i], 0.99, na.rm=TRUE)
#thr <- 3*mad(S[, i])

plot(data.scale[, i], type="l", main=paste("Sensor:", colnames(data.scale)[i]),
     xlab="time", ylab="value")
lines(L[, i], col="blue", lwd=2)         # clean (low-rank) signal
idx <- which(abs(S[, i]) > thr)  # robust per-sensor threshold
points(idx, data.scale[idx, i], col="red", pch=19, cex=.6)
legend("topleft", c("raw","low-rank","outlier"), col=c("black","blue","red"),
       lty=c(1,1,NA), pch=c(NA,NA,19), bty="n")
```

Heatmap: which sensors are abnormal, when?
```{r}
S_long <- melt(abs(S))
colnames(S_long) <- c("time","sensor","amp")

ggplot(S_long, aes(sensor, time, fill=amp)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title="RPCA anomaly heatmap (|S|)", x="", y="time") +
  theme_minimal()
```

Sequence
```{r}
rle_flags <- rle(flag_t)
ends  <- cumsum(rle_flags$lengths)
starts<- ends - rle_flags$lengths + 1
segments <- data.frame(start=starts[rle_flags$values],
                       end  =ends[  rle_flags$values])
segments$len <- segments$end - segments$start + 1
segments <- subset(segments, len >= 5)   # keep segments ≥ 5 samples
segments
```


#FA

```{r}
fa.parallel(data.scale, fm = 'ml')
```

```{r}
fa_fit <- fa(data.scale, nfactors = 4, rotate = "oblimin", fm = "ml")
Lambda <- as.matrix(fa_fit$loadings)
scores <- fa_fit$scores    # or factor.scores(X, fa_fit)$scores
```

```{r}
Lambda
```


```{r}
Xhat <- scores %*% t(Lambda)            # reconstruction
resid <- data.scale - Xhat

# Point anomaly score per time (global):
score_t <- rowSums(resid^2)             # or rowSums(abs(resid))
thr_t   <- quantile(score_t, 0.99)      # 1% tail (tune)
flag_t  <- score_t > thr_t

plot(score_t, type="l", main="FA anomaly score over time",
     xlab="time index", ylab="residual energy")
abline(h = thr_t, col="red", lty=2)
```

```{r}
sensor <- 'v2'  # or name via which(colnames(X)=="rpm")
idx <- which(abs(resid[, sensor]) > 3*mad(resid[, sensor]))

plot(data.scale[, sensor], type="l", main=paste("Sensor:", colnames(data.scale)[sensor]),
     xlab="time", ylab="scaled value")
lines(Xhat[, sensor], col="blue", lwd=2)         # FA reconstruction
points(idx, data.scale[idx, sensor], col="red", pch=19, cex=.6)
legend("topleft", c("raw","FA recon","outlier"),
       col=c("black","blue","red"), lty=c(1,1,NA), pch=c(NA,NA,19), bty="n")
```

```{r}
R_long <- melt(abs(resid)); colnames(R_long) <- c("time","sensor","amp")
ggplot(R_long, aes(sensor, time, fill = amp)) +
  geom_tile() + scale_fill_viridis_c() +
  labs(title="FA residual heatmap", x="", y="time") +
  theme_minimal()
```

```{r}
rle_flags <- rle(flag_t)
ends  <- cumsum(rle_flags$lengths)
starts<- ends - rle_flags$lengths + 1
segments <- data.frame(start=starts[rle_flags$values],
                       end  = ends[ rle_flags$values])
segments$len <- segments$end - segments$start + 1
subset(segments, len >= 5)  # keep segments ≥ 5 samples
```

